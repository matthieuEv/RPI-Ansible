---
- name: Install WireGuard
  apt:
    name:
      - wireguard
      - wireguard-tools
    state: present
    update_cache: yes

- name: Enable IP forwarding
  sysctl:
    name: net.ipv4.ip_forward
    value: '1'
    sysctl_set: yes
    state: present
    reload: yes

- name: Check if WireGuard private key exists
  stat:
    path: /etc/wireguard/private.key
  register: wg_private_key_file

- name: Generate WireGuard private key
  shell: wg genkey
  register: wg_genkey
  when: not wg_private_key_file.stat.exists

- name: Save WireGuard private key
  copy:
    content: "{{ wg_genkey.stdout }}"
    dest: /etc/wireguard/private.key
    owner: root
    group: root
    mode: '0600'
  when: not wg_private_key_file.stat.exists

- name: Read WireGuard private key
  slurp:
    src: /etc/wireguard/private.key
  register: wg_private_key_content

- name: Set WireGuard private key fact
  set_fact:
    wireguard_private_key: "{{ wg_private_key_content.content | b64decode | trim }}"

- name: Generate WireGuard public key
  shell: cat /etc/wireguard/private.key | wg pubkey
  register: wg_pubkey
  changed_when: false

- name: Save WireGuard public key
  copy:
    content: "{{ wg_pubkey.stdout }}"
    dest: /etc/wireguard/public.key
    owner: root
    group: root
    mode: '0644'

- name: Display server public key
  debug:
    msg: "WireGuard Server Public Key: {{ wg_pubkey.stdout }}"

- name: Deploy WireGuard configuration
  template:
    src: wg0.conf.j2
    dest: "/etc/wireguard/{{ wireguard.interface }}.conf"
    owner: root
    group: root
    mode: '0600'
  register: wg_config

- name: Enable WireGuard service
  systemd:
    name: "wg-quick@{{ wireguard.interface }}"
    enabled: yes

- name: Start WireGuard service
  systemd:
    name: "wg-quick@{{ wireguard.interface }}"
    state: started
  when: not wg_config.changed

- name: Restart WireGuard service (config changed)
  systemd:
    name: "wg-quick@{{ wireguard.interface }}"
    state: restarted
  when: wg_config.changed
